<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec"%>
<style>
.narrow-modal-button {
	width: 100px; /* 원하는 가로폭을 지정 */
    padding: 7px; /* 원하는 패딩을 지정 */
    margin: 23px;
    }
.modal-title {
    font-size: 18px; /* 원하는 글씨 크기로 조정 */
    font-weight: bold; /* 굵게 표시 */
    }
.table th, .table td, .table tr {
	border: 0.5px solid #e0e0e0;
	text-align: center;
}
.modal-body {
    max-height: calc(100vh - 350px); /* 예시로 모달 높이 제한 */
    overflow-y: auto;
  }
</style>
<div class="card box-shadow d-flex m-4" style="min-height: auto;">
      <div class="h-100">
      <div class="card-header" style="border-radius: 20px 20px 0 0; background-color:#154FA9; font-weight:bold; color:white; margin-bottom: 40px;">졸업이수 조건관리</div>
<table class="table table-hover" style="max-width: 1500px; margin: 0 auto;">
	<thead class="table-light">
		<tr>
			<th>단과 / 졸업요건</th>
			<c:forEach items="${graduationTypeList}" var="graduationType">
				<th>${graduationType.geGradCondType}</th>
			</c:forEach>
		</tr>
	</thead>
	<tbody>
		<c:set var="graduationConditionList" value="${graduationConditionList}" />
		<c:forEach items="${collegeTypeList}" var="collegeType" varStatus="loop">
			<tr>
				<td>${collegeType.colgeNm}</td>
				<c:forEach begin="0" end="${fn:length(graduationTypeList) - 1}" varStatus="gradLoop">
					<td>${graduationConditionList[loop.index + (gradLoop.index * fn:length(collegeTypeList))].gradCond}</td>
				</c:forEach>
			</tr>
		</c:forEach>
	</tbody>
</table>

<sec:authorize access="hasRole('ROLE_TS')">
	<div>
		<button type="button" class="btn btn-primary narrow-modal-button" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@getbootstrap" style="margin-left: 75px;">졸업요건수정</button>
		<button type="button" class="btn btn-primary narrow-modal-button" data-bs-toggle="modal" data-bs-target="#exampleModal2" data-bs-whatever="@getbootstrap">졸업요건추가</button>
		<button type="button" class="btn btn-primary narrow-modal-button" data-bs-toggle="modal" data-bs-target="#exampleModal3" data-bs-whatever="@getbootstrap">졸업요건삭제</button>
	</div>
</sec:authorize>
</div></div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog custom-modal-size">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">졸업 요건 수정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      	<form:form method="post" modelAttribute="graduation" action="${pageContext.request.contextPath}/graduation/updateGraduation.do">
          <div class="mb-3">
            <label for="select-box1" class="col-form-label">단과</label>
            <select class="form-select" id="select-box1" name="colgeCd">
            	<option value="">단과선택</option>
	              <c:forEach items="${collegeTypeList}" var="collegeType">
	              	<option value="${collegeType.colgeCd }">
	              		${collegeType.colgeNm}
	              	</option>
	              </c:forEach>
            </select>
          </div>

			<c:forEach items="${graduationTypeList}" var="graduationType">
	            <div class="mb-3">
	                <label class="col-form-label">
	                    ${graduationType.geGradCondType}
	                </label>
	                <form:input path="gradCond" class="form-control" />
	                <span class="error" style="color: red;"></span>
	                <input type="hidden" value="${graduationType.geGradCondType}" name="geGradCondType">
	            </div>
	        </c:forEach>

	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
	        <button type="submit" class="btn btn-primary">수정</button>
	      </div>
	    </form:form>
    </div>
  </div>
</div>

<div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog custom-modal-size">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">졸업 요건 추가</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      	<form:form method="post" modelAttribute="graduation" action="${pageContext.request.contextPath}/graduation/insertGraduation.do">
          <div class="mb-3">
            <label class="col-form-label" style="font-weight: bold;">졸업요건</label>
            	<form:input path="geGradCondType" class="form-control" />
          </div>

			<c:forEach items="${collegeTypeList}" var="collegeType" varStatus="loop">
			    <c:if test="${loop.index % 2 == 0}">
			        <div class="row">
			    </c:if>
			    <div class="col-md-6">
			        <div class="mb-3">
			            <label class="col-form-label">
			                ${collegeType.colgeNm}
			            </label>
			            <form:input path="gradCond" class="form-control"/>
			            <span class="error" style="color: red;"></span>
			            <input type="hidden" value="${collegeType.colgeCd}" name="colgeCd">
			        </div>
			    </div>
			    <c:if test="${loop.index % 2 != 0 || loop.last}">
			        </div>
			    </c:if>
			</c:forEach>

	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
	        <button type="submit" class="btn btn-primary">등록</button>
	      </div>
	    </form:form>
    </div>
  </div>
</div>

<div class="modal fade" id="exampleModal3" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog custom-modal-size">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">졸업 요건 삭제</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      	<form:form method="post" modelAttribute="graduation" action="${pageContext.request.contextPath}/graduation/deleteGraduation.do">
          <div class="mb-3">
            <label for="select-box1" class="col-form-label">요건선택</label>
            <select class="form-select" id="select-box" name="geGradCondType">
              <c:forEach items="${graduationTypeList}" var="graduationType">
              	<option value="${graduationType.geGradCondType }">
              		${graduationType.geGradCondType}
              	</option>
              </c:forEach>
            </select>
          </div>
	   </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
	        <button type="submit" class="btn btn-primary">삭제</button>
	      </div>
	    </form:form>
    </div>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("exampleModal").querySelector("form");
        form.addEventListener("submit", function(event) {
            const gradCondInputs = form.querySelectorAll('input[name="gradCond"]');
            let valid = true;

            gradCondInputs.forEach(function(input) {
                const errorSpan = input.nextElementSibling;
                if (input.value.trim() === "") {
                    errorSpan.textContent = "졸업 요건을 입력해주세요.";
                    valid = false;
                } else {
                    errorSpan.textContent = "";
                }
            });

            if (!valid) {
                event.preventDefault();
            }
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form2 = document.getElementById("exampleModal2").querySelector("form");
        form2.addEventListener("submit", function(event) {
            const gradCondInputs = form2.querySelectorAll('input[name="gradCond"]');
            let valid = true;

            gradCondInputs.forEach(function(input) {
                const errorSpan = input.nextElementSibling;
                if (input.value.trim() === "") {
                    errorSpan.textContent = "졸업 요건을 입력해주세요.";
                    valid = false;
                } else {
                    errorSpan.textContent = "";
                }
            });

            if (!valid) {
                event.preventDefault();
            }
        });
    });
</script>

<script>
$(document).ready(function() {
    const form = $("#exampleModal").find("form");
    const selectBox = $("#select-box1"); // 단과 선택 select 엘리먼트
    const gradCondInputs = form.find('input[name="gradCond"]'); // 졸업 요건 입력 input 엘리먼트
    
    selectBox.on("change", function() {
        const selectedColgeCd = selectBox.val();
        
        // AJAX 요청을 보내고 선택된 단과의 졸업 요건 정보를 가져옴
        $.ajax({
            url: "/oryuUniversity/graduation/changeCond.do",
            method : "get",
            data: { colgeCd: selectedColgeCd },
            success: function(data) {
                if (data && data.length > 0) {
                    for(var i = 0; i < data.length; i++) {
                    	var graduationVO = data[i];
                    	var gradCondInput = gradCondInputs.eq(i);
                        gradCondInput.val(graduationVO.gradCond);
                    }
                } else {
                    gradCondInputs.val(""); // 존재하지 않는 경우 값 초기화
                }
            },
            error: function(error) {
                console.error("Error fetching graduation condition:", error);
                gradCondInputs.val(""); // 에러 발생 시 값 초기화
            }
        });
    });
});
</script>